:toc:
:imagesdir: img

= CircleCI

== 初期設定

=== 基本設定
masterブランチにpushされた際の、デプロイ設定。

. CircleCIの `Add Projects` にて、対象のリポジトリを設定。
. 設定ファイル(`circleci.yml`)があるため、なにも設定はせず、「構築を開始」を選択。
. 必要に応じてGithub認証を行う。
. CircleCIの `Job` 画面を開き、対象リポジトリのmasterブランチを対象に `build` が行われている事を確認。

=== Herokuへのデプロイ設定
`master` ブランチに更新があった場合に自動デプロイをする設定。Heroku CLIで事前に、ログイン、初回デプロイを完了しておく(`Heroku.adoc` 参考)。

. アプリ名を取得。
    - アプリ作成時にアプリ名を指定している場合(`$ heroku create appname`)
        .. `appname` をメモ。
    - アプリ作成時にアプリ名を指定していない場合(`$ heroku create`)
        .. `$ heroku open` でアプリを開く。
        .. URLを確認し　`herokuapp.com` の前をメモ。 +
        例) `https://fast-fortress-35448.herokuapp.com/` => `fast-fortress-35448`
. 対象のHerokuアプリのAPIキーを取得。
    .. `$ heroku authorizations:create -d "getting started token"` でキーを発行。  
    ----
    Creating OAuth Authorization... done
    Client:      <none>
    ID:          XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
    Description: getting started token
    Scope:       global
    Token:       YYYYYYYY-YYYY-YYYY-XXXX-YYYYYYYYYYYY
    Updated at:  Mon Jan 13 2020 11:28:39 GMT+0900 (GMT+09:00) (less than a minute ago)
    ----
    .. `TOKEN:` の値をメモ。
. 対象のHerokuアプリのTOKENキーを取得。
    .. APIキーの取得と同様の値。
. CircleCIに環境変数を設定。
    .. CircleCIのサイトにログイン。
    .. `Workflows` 画面を開く。
    .. 基本設定で設定したリポジトリを選択。
    .. 右上の設定アイコン(歯車の)を選択。
    .. `Environment Variables` を選択。
    .. `Add Variable` ボタンで、表「Heroku 環境変数」を追加。
. 動作するか確認
    .. `home_controller#index` のmessageに変更を加える。
    .. リポジトリのmasterブランチにpush。
    .. CircleCIのサイト `Job` で対象のbuild~deployが完了したことを確認。
    .. `$ heroku open` で対象のアプリを開く。
    .. パス `system/test` を開き、`home_controller#index` での変更が反映されていることを確認。

.Heroku 環境変数
|===
|変数名 |値

|HEROKU_APP_NAME
|アプリ名

|HEROKU_API_KEY
|APIキー

|HEROKU_AUTH_TOKEN
|TOKENキー

|HEROKU_LOGIN
|Herokuアカウントのメールアドレス

|===